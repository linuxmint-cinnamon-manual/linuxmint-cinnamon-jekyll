    <h2 id="toc235"><a id="RefHeading19121713816058"></a><a id="bkmRefHeading19121713816058"></a><a id="toc234"></a><a id="bkmtoc234"></a><a id="RefHeading13121136957987"></a><a id="bkmRefHeading13121136957987"></a><a id="bkmRefHeading13121136957987"></a><a id="bkmbkmRefHeading13121136957987"></a>Индивидуализация системы</h2>
    <p class="Textbody">Последний очерк посвящается апофеозу знакомства с дистрибутивом Mint и его Cinnamon — сборке индивидуализированной системы на его основе. Как сказал то ли один из премьер-министров Великобритании, то ли некий президент Франции (кому только это изречение ни приписывали?):</p>
    <p class="Textbody">Тот, кто в (информационной) юности не мечтал собрать свой дистрибутив Linux'а, не имеет сердца. Тот, кто продолжает мечтать об этом в (информационной) зрелости — не имеет разума.</p>
    <p class="Textbody">Однако применительно к Linux Mint вполне возможно сочетать сердечность и разумность даже в преклонные годы, ибо собрать свою индивидуализированную систему на базе этого дистрибутива и просто, и полезно.</p>
    <h3 id="toc236"><a id="RefHeading19141713816058"></a><a id="bkmRefHeading19141713816058"></a><a id="toc235"></a><a id="bkmtoc235"></a><a id="RefHeading7121136957987"></a><a id="bkmRefHeading7121136957987"></a><a id="bkmRefHeading7121136957987"></a><a id="bkmbkmRefHeading7121136957987"></a>Свой Mint: введение</h3>
    <p class="Textbody">Во время первого знакомства с с Mint у меня сложилось впечатление, что в его инсталляции настолько мало лишних программ, что не стоило и заморачиваться с их удалением. Однако при дальнейшем рассмотрении оказалось, что лишних (для меня) приложений вполне достаточно — например, вся мультимедиа. С другой стороны, ряд привычных для меня программ (например, те же мультимединые) приходилось доустанавливать. И появилась мысль изготовить свой установочный диск этого дистрибутива. На котором не было бы ничего лишнего (повторяю, для меня). И, напротив, были бы все приложения, которые мне так или иначе пришлось доустанавливать.</p>
    <p class="Textbody">В сети можно найти упоминания о нескольких инструментах для изготовления собственного дистрибутива на базе Ubuntu и её производных (а Mint, как известно, принадлежит к их числу):</p>
    <ul style="margin-top:0;margin-bottom:0;list-style-type:disc;clear:left">
      <li>
        <p class="Textbody">oem-config-remaster — утилита командной строки, позволяющая сделать снапшот установленной системы; </p>
      </li>
      <li>
        <p class="Textbody">remastersys — утилита для резервного копирования установленной системы и создания на её базе Live-носителя; именно таким образом собирается, например, <a href="http://matuntu.ru/" target="_blank">дистрибутив Matuntu</a> — отечественный вариант Ubuntu с MATE в качестве рабочей среды; </p>
      </li>
      <li>
        <p class="Textbody">Ubuntu Builder-- программа с графическим интерфейсом, позволяющая скомпоновать свой дистрибутив попакетно. </p>
      </li>
    </ul>
    <p class="Textbody">Однако первые две показались мне сложноватыми и избыточными для моих целей, а последняя, похоже, прекратила своё развитие — версии её для Ubuntu Trusty, на которой основываются текущие релизы Mint, в PPA-репозитории не обнаружилось.</p>
    <p class="Textbody">И в итоге я остановился на программе Ubuntu Customization Kit (далее — UCK): гугление показало, что это примерно то, что мне нужно, ибо специально предназначается для коррекции состава пакетов в первую очередь.</p>
    <h3 id="toc237"><a id="RefHeading19161713816058"></a><a id="bkmRefHeading19161713816058"></a><a id="toc236"></a><a id="bkmtoc236"></a><a id="RefHeading7141136957987"></a><a id="bkmRefHeading7141136957987"></a><a id="bkmRefHeading7141136957987"></a><a id="bkmbkmRefHeading7141136957987"></a>UCK: обзор</h3>
    <p class="Textbody">Программа UCK в виде одноимённого пакета имеется в официальном репозитории, и потому может быть установлена любым из стандартных способов. После этого в секции Администрирование главного меню Cinnamon появляется пункт, который, как ни странно, называется Ubuntu Customization Kit, через который эту программу и можно запустить. Но прежде чем смотреть, что она после этого делает, попробуем представить, что у неё внутре.</p>
    <p class="Textbody">Всякий, кому приходилось заниматься модификацией существующего установочного образа какого-либо дистрибутива, представляет себе основные этапы этого процесса:</p>
    <ul style="margin-top:0;margin-bottom:0;list-style-type:disc;clear:left">
      <li>
        <p class="Textbody">монтирование образа как loop-устройства; </p>
      </li>
      <li>
        <p class="Textbody">развёртывание её файловой системы — нынче все дистрибутивы используют какой-либо механизм компрессии, в частности в убунтоидах это SquashFS; </p>
      </li>
      <li>
        <p class="Textbody">монтирование в loop-систему как связанных (bind) таких служебных, но абсолютно необходимых каталогов материнской системы, как /dev, /sys и, на всякий случай, /proc; </p>
      </li>
      <li>
        <p class="Textbody">выполнение операции chroot в loop-каталог, становящийся таким образом корневым; </p>
      </li>
      <li>
        <p class="Textbody">выполнение в chroot-окружении необходимых действий по удалению ненужных пакетов и установке необходимых; </p>
      </li>
      <li>
        <p class="Textbody">выход из chroot-окружения и обратная запаковка loop-каталога; </p>
      </li>
      <li>
        <p class="Textbody">размонтирование loop-устройства и создание из него загрузочного iso-образа с помощью isolinux. </p>
      </li>
    </ul>
    <p class="Textbody">Интуитивно понятно, что UCK не делает ничего иного, кроме перечисленного — он просто автоматизирует описанный процесс, делая его этапы почти незаметными для применителя.</p>
    <p class="Textbody">Основные исполняемые файлы пакета uck (а их 16 штук) собраны, понятное дело, в каталоге /usr/bin и имеют префикс uck-*. Все они являются самыми обычными шелл-скриптами, причём по их именам легко догадаться о назначении каждого. «Головным», то есть запускающим весь процесс скриптом является /usr/bin/uck-gui — именно он вызывается через пункт меню Администрирование -&gt; Ubuntu Customization Kit:</p>
    <p class="Textbody">
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_000.png">
        <img alt="Изображение579" class="frameGraphics" id="579graphic" src="http://alv.me/wp-content/img/im_cin_img/10-uck_000-572x417.png" style="border:1.0px solid #000080;padding:0;width:573.83685px;height:418.8385px" />
      </a>
      <a id="a581graphic"></a>
      <a id="bkm581graphic"></a>
    </p>
    <p class="Textbody">А через редактор меню можно посмотреть на его свойства:</p>
    <p class="Textbody">
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_000a.png">
        <img alt="Изображение580" class="frameGraphics" id="580graphic" src="http://alv.me/wp-content/img/im_cin_img/10-uck_000a.png" style="border:1.0px solid #000080;padding:0;width:471.82745px;height:212.85419px" />
      </a>
      <a id="a582graphic"></a>
      <a id="bkm582graphic"></a>
    </p>
    <p class="Textbody">По скриншоту можно догадаться о присутствии в строке запуска опции --wait-before-exit, отвечающей за ожидание нажатия Enter перед выходом из программы после успешного завершения её работы.</p>
    <p class="Textbody">Кстати говоря, при неуспешном завершении, то есть возникновении ошибки по любой причине (например, нехватке места на целевом устройстве), ничего не происходит, кроме остановки работы. Никаких возвратов назад не предусмотрено, остаётся только закрывать главное терминальное окно программы (о котором далее) и начинать всё сначала. Так что, учитывая длительность распаковки SquashFS и необходимость удаления образовавшихся в процессе файлов (а их — многие десятки тысяч, что на файловой системе, например, XFS затягивается очень надолго), лучше действовать аккуратно и по возможности не ошибаться.</p>
    <p class="Textbody">Команда uck-gui запускается от лица обычного пользователя — пароль для доступа к административным привилегиям запрашивается только тогда, когда они на самом деле потребуются. Кроме указанной --wait-before-exit, она имеет ещё как минимум две опции. Первая, -m, обеспечивающая кеширование модифицированных частей образа, работает, как сказано в man (1) uck-gui, не всегда, и потому в стандартной ситуации не используется.</p>
    <p class="Textbody">Вторая опция также штатно не задействована, но она может оказаться важной для применителя. Это опция remaster-dir, определяющая рабочий каталог для UCK, отличный от умолчального ~/tmp. Через редактор меню Cinnamon я переопределил этот каталог как ~/data/my-mint, поэтому итоговая команда для запуска UCK через меню приобрела такой вид:</p>
    <p class="Textbody" style="margin-top:0;margin-bottom:17.990553px"><span style="background-color:#dddddd">uck-gui --wait-before-exit /home/data/my-mint</span> </p>
    <p class="Textbody">Кроме запуска процесса, сценарий uck-gui отвечает, в том числе, и за выбор типа десктопа — unity, gnome, kde, или others. Однако попытки вносить здесь какие-либо изменения (например, пополнение списка доступных десктопов) никакого результата за собой не повлекут. То есть добавленные десктопы появятся в меню их выбора, но ничего не изменится.</p>
    <p class="Textbody">Потому что на самом деле кроме исполняемых скриптов в каталоге /usr/bin, основным компонентом UCK является также каталог /usr/lib/uck/. А в нём, кроме всего прочего — файл /usr/lib/uck/customization-profiles/localized_cd/customize, представляющий собой исполняемый шелл-сценарий, который отвечает в том числе и за вызов терминальной программы. Запомним его — в некоторых случаях он подлежит ручному редактированию.</p>
    <p class="Textbody">Впрочем, всё сказанное проще продемонстрировать на примере конкретной сборки своего варианта дистрибутива, чем мы сейчас и займёмся.</p>
    <h3 id="toc238"><a id="RefHeading19181713816058"></a><a id="bkmRefHeading19181713816058"></a><a id="toc237"></a><a id="bkmtoc237"></a><a id="RefHeading7161136957987"></a><a id="bkmRefHeading7161136957987"></a><a id="bkmRefHeading7161136957987"></a><a id="bkmbkmRefHeading7161136957987"></a>UCK: процесс</h3>
    <p class="Textbody">Сразу после запуска UCK перед нами появляется пустое терминальное окно и на фоне его — приглашение программы:</p>
    <p class="Textbody">
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_001.png">
        <img alt="Изображение581" class="frameGraphics" id="581graphic" src="http://alv.me/wp-content/img/im_cin_img/10-uck_001-572x346.png" style="border:1.0px solid #000080;padding:0;width:573.83685px;height:347.85892px" />
      </a>
      <a id="a583graphic"></a>
      <a id="bkm583graphic"></a>
    </p>
    <p class="Textbody">В нём указаны системные требования, не являющие собой ничего сверхъестественного: 5 ГБ свободного пространства в каталоге ~/tmp (или его аналоге, определённом выше) и доступ в Интернет. Так что можно смело нажимать OK и приступать к кастомизации, которая начинается<br />с выбора локали — сначала для инсталлятора:</p>
    <p class="Textbody">
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_002.png">
        <img alt="Изображение582" class="frameGraphics" id="582graphic" src="http://alv.me/wp-content/img/im_cin_img/10-uck_002.png" style="border:1.0px solid #000080;padding:0;width:501.83685px;height:401.83054px" />
      </a>
      <a id="a584graphic"></a>
      <a id="bkm584graphic"></a>
    </p>
    <p class="Textbody">Затем — для Live-носителя:</p>
    <p class="Textbody">
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_003.png">
        <img alt="Изображение583" class="frameGraphics" id="583graphic" src="http://alv.me/wp-content/img/im_cin_img/10-uck_003-572x355.png" style="border:1.0px solid #000080;padding:0;width:573.83685px;height:356.8542px" />
      </a>
      <a id="a585graphic"></a>
      <a id="bkm585graphic"></a>
    </p>
    <p class="Textbody">И наконец — для и инсталлированной системы:</p>
    <p class="Textbody">
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_004.png">
        <img alt="Изображение584" class="frameGraphics" id="584graphic" src="http://alv.me/wp-content/img/im_cin_img/10-uck_004.png" style="border:1.0px solid #000080;padding:0;width:501.83685px;height:401.83054px" />
      </a>
      <a id="a586graphic"></a>
      <a id="bkm586graphic"></a>
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_004.png"> </a>
    </p>
    <p class="Textbody">Список всех доступных содержится в файле /usr/lib/uck/langlist. Причём, при желании иметь русифицированную систему, можно ограничиться отметкой боксика ru во всех трёх случаях. Впрочем, в Live-среде локаль всё равно останется en_US (о чём программа честно предупреждает). Однако язык инсталлтора будет русским. А в установленной системе локаль по умолчанию определится как надо:</p>
    <p class="Textbody"><span style="background-color:#dddddd">~ $ locale</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">LANG=ru_RU.UTF-8</span> </p>
    <p class="Textbody" style="margin-top:0;margin-bottom:17.990553px"><span style="background-color:#dddddd">...</span> </p>
    <p class="Textbody">И к ней автоматически добавятся такие:</p>
    <p class="Textbody"><span style="background-color:#dddddd">~ $ locale -a</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">C</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">C.UTF-8</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">en_AG</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">en_AG.utf8</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">en_AU.utf8</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">en_BW.utf8</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">en_CA.utf8</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">en_DK.utf8</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">en_GB.utf8</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">en_HK.utf8</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">en_IE.utf8</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">en_IN</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">en_IN.utf8</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">en_NG</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">en_NG.utf8</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">en_NZ.utf8</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">en_PH.utf8</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">en_SG.utf8</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">en_US.utf8</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">en_ZA.utf8</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">en_ZM</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">en_ZM.utf8</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">en_ZW.utf8</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">POSIX</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">ru_RU.utf8</span> </p>
    <p class="Textbody" style="margin-top:0;margin-bottom:17.990553px"><span style="background-color:#dddddd">ru_UA.utf8</span> </p>
    <p class="Textbody">Правда в Mint, в отличие от Ubuntu, ни одна из многочисленных английских локалей не будет всплывать в самый неподходящий момент.</p>
    <p class="Textbody">Следующий шаг кастомизации — выбор рабочей среды:</p>
    <p class="Textbody">
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_005.png">
        <img alt="Изображение585" class="frameGraphics" id="585graphic" src="http://alv.me/wp-content/img/im_cin_img/10-uck_005-572x372.png" style="border:1.0px solid #000080;padding:0;width:573.83685px;height:373.82428px" />
      </a>
      <a id="a587graphic"></a>
      <a id="bkm587graphic"></a>
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_005.png"> </a>
    </p>
    <p class="Textbody">На самом деле он определяет не среду, а терминальную программу, в которой будет жить chroot-окружение. При выборе первых трёх вариантов её будет соответствующий штатный терминал (Konsole, GNOME Terminal или Xfce Terminal), в случае варианта четвёртого будут просто перебраны они же плюс LXTerminal из LXDE. Соответственно, запустится тот, что найдётся первым, так что выбор пункта other подойдёт в подавляющем большинстве случаев, вне зависимости от десктопа, используемого на потрошимом Live-носителе.</p>
    <p class="Textbody">На самый крайняк предусмотрен запуск XTerm, который, казалось бы, имеется в любом дистрибутиве. Но вот в Mint'е ни в одной официальной редакции его как раз нет. Поэтому при сборке системы с десктопом MATE потребуется редактирование того самого файла /usr/lib/uck/customization-profiles/localized_cd/customize, который я ранее предлагал запомнить. То есть в его секцию function run_console() следует вписать такие строки:</p>
    <p class="Textbody"><span style="background-color:#dddddd">         if [ «$CONSOLE_APP» = «» ]; then</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">                 CONSOLE_APP=`which mate-terminal`</span> </p>
    <p class="Textbody" style="margin-top:0;margin-bottom:17.990553px"><span style="background-color:#dddddd">                 CONSOLE_APP_OPTIONS=(-t «UCK customization console» -e /bin/bash)</span> </p>
    <p class="Textbody">Я на всякий случай дописал в него также определения для терминальных программ Sakura и Terminator, которые временами использую.</p>
    <p class="Textbody"><span style="background-color:#dddddd">        if [ «$CONSOLE_APP» = «» ]; then</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">                CONSOLE_APP=`which terminator`</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">                CONSOLE_APP_OPTIONS=(-t «UCK customization console» -e /bin/bash)</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">        fi</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">        if [ «$CONSOLE_APP» = «» ]; then</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">                CONSOLE_APP=`which sakura`</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">                CONSOLE_APP_OPTIONS=(-t «UCK customization console» -e /bin/bash)</span> </p>
    <p class="Textbody" style="margin-top:0;margin-bottom:17.990553px"><span style="background-color:#dddddd">        fi</span> </p>
    <p class="Textbody">Теоретически тут можно переопределить и командную оболочку (например, /bin/zsh), но я этим заморачиваться не стал.</p>
    <p class="Textbody">Теперь потребовуется выбрать образ диска, который будет подвергнут потрошению — через обычное окно открытия файла. После чего будущему образу предлагается дать имя:</p>
    <p class="Textbody">
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_006.png">
        <img alt="Изображение586" class="frameGraphics" id="586graphic" src="http://alv.me/wp-content/img/im_cin_img/10-uck_006.png" style="border:1.0px solid #000080;padding:0;width:573.83685px;height:138.85101px" />
      </a>
      <a id="a588graphic"></a>
      <a id="bkm588graphic"></a>
    </p>
    <p class="Textbody">Впрочем, имя это, насколько я понял, в дальнейшем нигде не используется, так что особо напрягать свою фантазию не нужно.</p>
    <p class="Textbody">Далее следует серия вопросов — о желании кастомизировать будущий образ мануально:</p>
    <p class="Textbody">
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_007.png">
        <img alt="Изображение587" class="frameGraphics" id="587graphic" src="http://alv.me/wp-content/img/im_cin_img/10-uck_007.png" style="border:1.0px solid #000080;padding:0;width:501.83685px;height:401.83054px" />
      </a>
      <a id="a589graphic"></a>
      <a id="bkm589graphic"></a>
    </p>
    <p class="Textbody">Об удалении Windows-related файлов, типа autorun.inf (которых, впрочем, на установочном носителе Mint и так нет):</p>
    <p class="Textbody">
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_008.png">
        <img alt="Изображение588" class="frameGraphics" id="588graphic" src="http://alv.me/wp-content/img/im_cin_img/10-uck_008.png" style="border:1.0px solid #000080;padding:0;width:501.83685px;height:401.83054px" />
      </a>
      <a id="a590graphic"></a>
      <a id="bkm590graphic"></a>
    </p>
    <p class="Textbody">О создании гибридного образа — то есть пригодного для записи как на OD, так и на USB:</p>
    <p class="Textbody">
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_009.png">
        <img alt="Изображение589" class="frameGraphics" id="589graphic" src="http://alv.me/wp-content/img/im_cin_img/10-uck_009.png" style="border:1.0px solid #000080;padding:0;width:501.83685px;height:401.83054px" />
      </a>
      <a id="a591graphic"></a>
      <a id="bkm591graphic"></a>
    </p>
    <p class="Textbody">На все эти вопросы я, по понятным причинам, отвечал положительно, иначе и говорд городить бы не стоило.</p>
    <p class="Textbody">Далее сообщается, что вся необходимая информация собрана, по введении пароля можно приступать к сборке диска, который будет помещён в path2/remaster-new-files под именем livecd.iso (спрашивается, зачем придумывать ему осмысленное имя?):</p>
    <p class="Textbody">
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_010.png">
        <img alt="Изображение590" class="frameGraphics" id="590graphic" src="http://alv.me/wp-content/img/im_cin_img/10-uck_010.png" style="border:1.0px solid #000080;padding:0;width:501.83685px;height:401.83054px" />
      </a>
      <a id="a592graphic"></a>
      <a id="bkm592graphic"></a>
    </p>
    <p class="Textbody">А для начала процесса в исходном терминальном окне надо ввести пароль для доступа к адмнистративным привилегиям:</p>
    <p class="Textbody">
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_011.png">
        <img alt="Изображение591" class="frameGraphics" id="591graphic" src="http://alv.me/wp-content/img/im_cin_img/10-uck_011-572x326.png" style="border:1.0px solid #000080;padding:0;width:573.83685px;height:327.82742px" />
      </a>
      <a id="a593graphic"></a>
      <a id="bkm593graphic"></a>
    </p>
    <p class="Textbody">Вслед за этим происходит монтирование исходного образа, его разворачивание и декомпрессии SquashFS, которая занимает немало времени:</p>
    <p class="Textbody">
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_012.png">
        <img alt="Изображение592" class="frameGraphics" id="592graphic" src="http://alv.me/wp-content/img/im_cin_img/10-uck_012-572x326.png" style="border:1.0px solid #000080;padding:0;width:573.83685px;height:327.82742px" />
      </a>
      <a id="a594graphic"></a>
      <a id="bkm594graphic"></a>
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_012.png"> </a>
    </p>
    <p class="Textbody">Когда же она закончится, каталог, определённый в качестве remaster-dir, будет выглядеть так:</p>
    <p class="Textbody"><span style="background-color:#dddddd">ls [remaster-dir]</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">build.log</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">customization-scripts/</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">remaster-apt-cache/</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">remaster-new-files/</span> </p>
    <p class="Textbody"><span style="background-color:#dddddd">remaster-root/</span> </p>
    <p class="Textbody" style="margin-top:0;margin-bottom:17.990553px"><span style="background-color:#dddddd">remaster-root/home</span> </p>
    <p class="Textbody">Очевидно, что build.log содержит протоколирование хода процесса, а в каталоге customization-scripts/ собраны скрипты кастомизации, сгенерированные посредством сценариев из /usr/lib/uck/. В каталоге remaster-apt-cache/ будет помещён локальный кеш устанавливаемых пакетов, а сами они в подкаталоге remaster-apt-cache/archives — аналоге /var/cache/apt/archives установленной системы. Таким образом, скачанные пакеты не засоряют ни корень развёрнутой из Live-образа системы (он расположен в каталоге remaster-root/), ни, тем более, каталог для сборки уже непосредственно нового образа — remaster-new-files/. В последнем после успешного завершения всего предприятия этот самый образ, под именем livecd.iso, и окажется. Ну а remaster-root/home, ясное дело, является домашним каталогом администратора (аналог /root обычной файловой иерархии).</p>
    <p class="Textbody">Далее предлагается выбрать «заказное» действие — Run console application или Continue building:</p>
    <p class="Textbody">
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_013.png">
        <img alt="Изображение593" class="frameGraphics" id="593graphic" src="http://alv.me/wp-content/img/im_cin_img/10-uck_013.png" style="border:1.0px solid #000080;padding:0;width:501.83685px;height:401.83054px" />
      </a>
      <a id="a595graphic"></a>
      <a id="bkm595graphic"></a>
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_013.png"> </a>
    </p>
    <p class="Textbody">Выбор первого пункта очевиден. Он влечёт за собой выполнение той самой команды chroot, о которой я говорил раньше, и запуск того самого терминала, который был неявным образом определён на стадии так называемого выбора десктопа:</p>
    <p class="Textbody">
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_014.png">
        <img alt="Изображение594" class="frameGraphics" id="594graphic" src="http://alv.me/wp-content/img/im_cin_img/10-uck_014-572x357.png" style="border:1.0px solid #000080;padding:0;width:573.83685px;height:358.85733px" />
      </a>
      <a id="a596graphic"></a>
      <a id="bkm596graphic"></a>
    </p>
    <p class="Textbody">Обращаю внимание — командная оболочка в терминале — Bash, запущенная от лица администратора. То есть в дальнейшем для установки/удаления пакетов и прочих подобных мероприятий команда sudo не понадобится.</p>
    <p class="Textbody">Если предыдущие стадии завершились успешно, то начинается самое важное: собственно потрошение исходного образа. Тут требуется аккуратность и последовательность, нарушение которой влечёт ошибки, которые, как я уже говорил, крайне нежелательны. Так что в следующем миниочерке процедура потрошения будет рассмотрена подробно. А пока завершу описание основного процесса.</p>
    <p class="Textbody">По завершении потрошения опять возникает панель с предложением выбрать «заказное» действие — и теперь столь же очевиден выбор второго из них:</p>
    <p class="Textbody">
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_015.png">
        <img alt="Изображение595" class="frameGraphics" id="595graphic" src="http://alv.me/wp-content/img/im_cin_img/10-uck_015.png" style="border:1.0px solid #000080;padding:0;width:501.83685px;height:401.83054px" />
      </a>
      <a id="a597graphic"></a>
      <a id="bkm597graphic"></a>
    </p>
    <p class="Textbody">После чего начнается исполнение сценариев кастомизации, плавно переходящее в компрессию системы в виде SquashFS — это будет самым долгим делом во всём процессе:</p>
    <p class="Textbody">
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_016.png">
        <img alt="Изображение596" class="frameGraphics" id="596graphic" src="http://alv.me/wp-content/img/im_cin_img/10-uck_016-572x326.png" style="border:1.0px solid #000080;padding:0;width:573.83685px;height:327.82742px" />
      </a>
      <a id="a598graphic"></a>
      <a id="bkm598graphic"></a>
    </p>
    <p class="Textbody">Однако всё когда-нибудь кончается — и упаковка SquashFS закончится сообщением об успехе операции и напоминанием о том, где и под каким именем можно найти её результат:</p>
    <p class="Textbody">
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_017.png">
        <img alt="Изображение597" class="frameGraphics" id="597graphic" src="http://alv.me/wp-content/img/im_cin_img/10-uck_017.png" style="border:1.0px solid #000080;padding:0;width:501.83685px;height:401.83054px" />
      </a>
      <a id="a599graphic"></a>
      <a id="bkm599graphic"></a>
    </p>
    <p class="Textbody">Приняв это к сведению, я узнал, что собранный образ не вместится на стандартный семисотмегабайтный CD:</p>
    <p class="Textbody">
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_018.png">
        <img alt="Изображение598" class="frameGraphics" id="598graphic" src="http://alv.me/wp-content/img/im_cin_img/10-uck_018.png" style="border:1.0px solid #000080;padding:0;width:501.83685px;height:401.83054px" />
      </a>
      <a id="a600graphic"></a>
      <a id="bkm600graphic"></a>
    </p>
    <p class="Textbody">Что, как выяснилось, соответствовало действительности, о чём скажу в следующем миниочерке. А пока оставалось только нажать OK, что повлекло закрытие окна сборки. А в первом терминале — нажать Enter, в результате закроется и он:</p>
    <p class="Textbody">
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_019.png">
        <img alt="Изображение599" class="frameGraphics" id="599graphic" src="http://alv.me/wp-content/img/im_cin_img/10-uck_019-572x326.png" style="border:1.0px solid #000080;padding:0;width:573.83685px;height:327.82742px" />
      </a>
      <a id="a601graphic"></a>
      <a id="bkm601graphic"></a>
    </p>
    <p class="Textbody">А итоговый образ, как уже говорилось, можно найти в каталоге /home/data/my-mint/remaster-new-files под именем livecd.iso.</p>
    <h3 id="toc239"><a id="RefHeading19201713816058"></a><a id="bkmRefHeading19201713816058"></a><a id="toc238"></a><a id="bkmtoc238"></a><a id="RefHeading7181136957987"></a><a id="bkmRefHeading7181136957987"></a><a id="bkmRefHeading7181136957987"></a><a id="bkmbkmRefHeading7181136957987"></a>«Потрошение» образа</h3>
    <p class="Textbody">А теперь я вернусь назад и расскажу о своём опыте «потрошения» исходного образа Cinnamon-редакции Mint. Не как пример для подражания или, тем более, копирования, но как вариант возможных действий. И себе на память — в качестве шпаргалки, тоже пригодится.</p>
    <p class="Textbody">«Потрошению» подвергся образ Cinnamon-редакции Mint 17.1 Rebecca в 64-битном варианте:</p>
    <p class="Textbody">
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_020.png">
        <img alt="Изображение600" class="frameGraphics" id="600graphic" src="http://alv.me/wp-content/img/im_cin_img/10-uck_020-572x537.png" style="border:1.0px solid #000080;padding:0;width:573.83685px;height:538.83844px" />
      </a>
      <a id="a602graphic"></a>
      <a id="bkm602graphic"></a>
      <a href="http://alv.me/wp-content/img/2015/01/10-uck_020.png"> </a>
    </p>
    <p class="Textbody">Для начала я подключил PPA-репозитории, которые предполагал использовать:</p>
    <p class="Textbody" style="margin-top:0;margin-bottom:17.990553px"><span style="background-color:#dddddd"># add-apt-repository -y ppa:mystic-mirage/komodo-edit &amp;&amp; add-apt-repository -y  ppa:zfs-native/stable &amp;&amp; add-apt-repository -y ppa:andrew-crew-kuznetsov/crew</span> </p>
    <p class="Textbody">Напоминаю, что командная оболочка запущена от имени администратора, что символизиуется видом приглашения командной строки в виде решётки #.</p>
    <p class="Textbody">Подключение репозиториев можно проделать и с помощью mintsources, запустив его из командной строки. И тут только не следует тянуть с этим делом — после удаления ненужных (мне) программ он может работать с ошибками. Если же прибегнуть к стандартному add-apt-repository, то этой проблемы не возникает, и подключение PPA-репозиториев можно отложить.</p>
    <p class="Textbody">Как обычно, подключение репозиториев надо завершить обновлением кеша пакетов:</p>
    <p class="Textbody" style="margin-top:0;margin-bottom:17.990553px"><span style="background-color:#dddddd"># apt update</span> </p>
    <p class="Textbody">И теперь, казалось бы, самое время выполнить общее обновление системы. Однако — увы: у меня оно ни разу не проходило ни через mintupdate, ни через apt upgrade ни в каких вариантах: ни с отключением Менеджера обновлений в хост-системе в первом случае, ни с ручной фиксацией версий пакетов, не обновляемых mintupdate — во втором. Так что попытки эти я оставил, переходя сразу к удалению пакетов, которые полагаю лишними — Libreoffice, GIMP, все мультимедийные, Thunderbird и всякие мелочи, типа Tomboy:</p>
    <p class="Textbody" style="margin-top:0;margin-bottom:17.990553px"><span style="background-color:#dddddd"># apt purge tomboy gimp thunderbird libreoffice* banshee brasero totem vlc gimp-data libgimp2.0</span> </p>
    <p class="Textbody">Далее настала очередь шрифтов — удалению подверглись кхмерские, таиландские и прочие шрифты, столь необходимые в наших широтах:</p>
    <p class="Textbody" style="margin-top:0;margin-bottom:17.990553px"><span style="background-color:#dddddd"># apt purge fonts-kacst fonts-kacst-one fonts-khmeros-core fonts-lao fonts-lklug-sinhala fonts-nanum fonts-sil-abyssinica fonts-sil-padauk fonts-takao-pgothic fonts-thai-tlwg fonts-tibetan-machine fonts-tlwg-garuda fonts-tlwg-kinnari fonts-tlwg-loma fonts-tlwg-mono fonts-tlwg-purisa fonts-tlwg-sawasdee fonts-tlwg-typewriter fonts-tlwg-typist fonts-tlwg-typo fonts-tlwg-umpush fonts-tlwg-waree ttf-indic-fonts-core ttf-punjabi-fonts</span> </p>
    <p class="Textbody">И напоследок — удаление драйверов видеокарт, последние представители которых были списаны в утиль много лет назад:</p>
    <p class="Textbody"><span style="background-color:#dddddd"># apt purge</span> </p>
    <p class="Textbody" style="margin-top:0;margin-bottom:17.990553px"><span style="background-color:#dddddd">xserver-xorg-video-cirrus xserver-xorg-video-mga xserver-xorg-video-neomagic xserver-xorg-video-openchrome xserver-xorg-video-qxl xserver-xorg-video-s3 xserver-xorg-video-savage xserver-xorg-video-siliconmotion xserver-xorg-video-sis xserver-xorg-video-sisusb xserver-xorg-video-tdfx xserver-xorg-video-trident xserver-xorg-video-ati xserver-xorg-video-mach64 xserver-xorg-video-vmware xserver-xorg-video-vmware</span> </p>
    <p class="Textbody">Массовое удаление пакетов по традиции следует завершать командой</p>
    <p class="Textbody" style="margin-top:0;margin-bottom:17.990553px"><span style="background-color:#dddddd"># apt autoremove</span> </p>
    <p class="Textbody">Она удаляет «осиротелые» зависимости, от которых больше ничего не зависит. Впрочем, в моём случае таковых не оказалось.</p>
    <p class="Textbody">Теперь настало время <span style="text-decoration:line-through">собирать камни</span> устанавливать пакеты. Каковых оказалось не так много:</p>
    <p class="Textbody" style="margin-top:0;margin-bottom:17.990553px"><span style="background-color:#dddddd"># apt install zsh gprename hunspell-ru-ie-yo mc mdadm uck shutter komodo-edit komodo-edit-ru gnumeric abiword gnome-mplayer asunder lame flac terminator tilda yagf system-config-lvm f2fs-tools nilfs-tools btrfs-tools ubuntu-zfs google-earth-stable virtualbox-4.3</span> </p>
    <p class="Textbody">Вдаваться в объяснения, почему именно эти пакеты, полагаю здесь неуместным. Ну а порядок их перечисления в строк — абсолютно случайный, и образовался по мере воспоминания.</p>
    <p class="Textbody">Напоследок была установлена новая Opera, предварительно скачанная и помещённая в каталог path2/remaster-root/tmp:</p>
    <p class="Textbody" style="margin-top:0;margin-bottom:17.990553px"><span style="background-color:#dddddd"># apt deb path2/remaster-root/tmp</span> </p>
    <p class="Textbody">После установки пакетов остались последние штрихи — обеспечить «нескучные обои» некоторые мелочи. Первая задача была решена лобовым копированием с хост-системы (и в её среде) каталога с моими любимыми фоновыми картинками в каталог path2/remaster-root/usr/share/backgrounds. И созданием (уже в chroot-окружении) символической ссылки:</p>
    <p class="Textbody" style="margin-top:0;margin-bottom:17.990553px"><span style="background-color:#dddddd"># ln -s ../linuxmint-alv/Mount_of_the_Rising_Sun.jpg \ default_background.jpg</span> </p>
    <p class="Textbody">Далее, с хост-системы же были перенесены настроечные файлы:</p>
    <ul style="margin-top:0;margin-bottom:0;list-style-type:disc;clear:left">
      <li>
        <p class="Textbody">мои конфиги для Zsh — ~/.zshrc и ~/.zshenv — в каталог /etc/zsh под именами newuser.zshrc.recommended и zshenv, соответственно; </p>
      </li>
      <li>
        <p class="Textbody">файла customize, описывающего доступные для UNC терминалы — в каталог path2/remaster-root/usr/lib/uck/customization-profiles/localized_cd/ (с тем же именем); </p>
      </li>
      <li>
        <p class="Textbody">файлов словаря для русского спеллинга в Komodo Edit (ru_RU.aff и ru_RU.dic) — в калалог path2/remaster-root/usr/lib/komodo-edit/mozilla/dictionaries. </p>
      </li>
    </ul>
    <p class="Textbody">И теперь оставалось только выйти из chroot-окружения и дождаться окончания сборки нового образа. Объём которого составил 1484 МБ — против 1478 МБ образа исходного. Но я и не ставил своей целью его уменьшение.</p>
    <p class="Textbody">Получившийся образ был скопирован куда надо, получил нормальное имя alv-rebecca.02.iso и контрольную сумму командой</p>
    <p class="Textbody" style="margin-top:0;margin-bottom:17.990553px"><span style="background-color:#dddddd">$ md5sum alv-rebecca.02.iso &gt; alv-rebecca.02.md5</span> </p>
    <p class="Textbody">После этого образ подвергся проверке сначала в Live-режиме, а затем был установлен в виртуальной машине — проверять его на реальном железе мне в данный момент негде. Тем не менее, поскольку все предыдущие опыты такого рода заканчивались успешно, я решил поделиться своим образом с народом — вдруг кому пригодится. Так что скачать его можно с <a href="https://yadi.sk/d/GX2m7lpMeFbYd" target="_blank">Яндекс.Диска</a>.</p>
    <h3 id="toc240"><a id="RefHeading19221713816058"></a><a id="bkmRefHeading19221713816058"></a><a id="toc239"></a><a id="bkmtoc239"></a><a id="RefHeading7201136957987"></a><a id="bkmRefHeading7201136957987"></a><a id="bkmRefHeading7201136957987"></a><a id="bkmbkmRefHeading7201136957987"></a>Заключение</h3>
    <p class="Textbody">В заключение этого очерка скажу пару слов о том, зачем всё это делалось и делается — хотя, возможно, с этого следовало начать. Ибо вопрос этот возникает возникает довольно часто. Правда, я обычно отвечаю на него не вполне политкорректно:</p>
    <p class="Textbody">Если вы не знаете, зачем это — значит, вам это не нужно.</p>
    <p class="Textbody">Но можно попробовать ответить и иначе. Собирал я образы, разумеется, в первую очередь для себя, любимого, дабы иметь возможность устанавливать Mint с его Cinnamon в той комплектации, которая устраивает меня на 146%.</p>
    <p class="Textbody">Во-вторых, с этого образа система будет устанавливаться на машины моих товарищей, не имеющих, по большей части, сложившихся предпочтений по части прикладного софта.</p>
    <p class="Textbody">В-третьих, образ может быть использован для не совсем стандартных инсталляций, например, с подключением softRAID, что штатно его инсталлятором не поддерживается, на файловую систему Ext4 с отключённым журналирование (что до недавнего времени пропагандировалось Google как самое быстрое решение), для подключения существующего пула ZFS или создания нового.</p>
    <p class="Textbody">В четвёртых, просто для экспериментов с дисковыми разделами и файловыми системами, в том числе и с относительно экзотическими, такими, как f2fs или nilfs2.</p>
    <p class="Textbody">И, наконец, в-пятых и последних — этот образ может послужить основой для специализированных сборок под некоторые задачи, например, связанные с цифровой картографией.</p>
